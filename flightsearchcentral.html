<html>
    <head>

        <title>Flight search central</title>
        <link rel="stylesheet" type="text/css" class="ui" href="https://semantic-ui.com//dist/semantic.min.css">

        <style type="text/css">
            body { padding: 2rem 0 2rem 0; }
            .query .row { margin: 1rem 0 0 0; border-top: 1px dashed #888888; }
            .query .row .field { padding: 0.25rem 0 0.25rem 0; }
            .actions { margin: 1rem 0 0 0; padding: 2rem 0 0 0; border-top: 1px dashed #888888; }
        </style>

        <script type="text/javascript" src="https://semantic-ui.com/dist/semantic.min.js"></script>
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script type="text/javascript" src="https://momentjs.com/downloads/moment.min.js"></script>

        <script type="text/javascript">
            let flightsearcherWebsiteProviders = {};
        </script>

        <script type="text/javascript" src="js/kayak.eu.js"></script>
        <script type="text/javascript" src="js/momondo.de.js"></script>
        <script type="text/javascript" src="js/skyscanner.de.js"></script>
        <script type="text/javascript" src="js/klm.de.js"></script>

    </head>
    <body>

        <div class="ui container">

            <header class="ui header">
                <i class="plane icon"></i>
                <div class="content">
                    Search flights
                    <div class="sub header">Enter query</div>
                </div>
            </header>

            <div class="query ui grid form">
            </div>

            <div class="actions ui grid">
                <div class="row">
                    <button id="openWebsitesButton" class="ui primary button">Open websites</button>
                </div>
            </div>

        </div>

        <script type="text/javascript">

            let index = 0;
            let flightSearchModel = null;

            function recomputeModel() {

                flightSearchModel = {
                    flights: new Array(),
                    activePages: new Array()
                };

                let flightSearchModelProperties = $(".flightSearchModel");
                for (let i=0; i < flightSearchModelProperties.length; i++) {
                    let flightSearchModelPropertyElement = $(flightSearchModelProperties[i]);
                    if (flightSearchModelPropertyElement.val().length > 0) {
                        flightSearchModel[flightSearchModelPropertyElement.attr("data-property-name")] = flightSearchModelPropertyElement.val();
                    }
                }
                let flightRows = $(".flight");
                for (let i=0; i < flightRows.length; i++) {
                    let flightRow = $(flightRows[i]);
                    let flightModel = {};
                    let inputFields = flightRow.find(".flightModel");
                    for (let j=0; j < inputFields.length; j++) {
                        let inputField = $(inputFields[j]);
                        flightModel[inputField.attr('data-property-name')] = inputField.val();
                    }
                    flightSearchModel.flights.push(flightModel);
                }
                let pageCheckboxes = $(".activePageModel");
                for (let i=0; i < pageCheckboxes.length; i++) {
                    let pageCheckbox = $(pageCheckboxes[i]);
                    if (pageCheckbox.prop("checked")) {
                        flightSearchModel.activePages.push(pageCheckbox.attr("data-page-name"));
                    }
                }

                localStorage.setItem("flightSearchModel", JSON.stringify(flightSearchModel));

            }

            function closeRow(rowId) {
                $("#" + rowId).remove();
                recomputeModel();
            }

            function addFlightRow(flightModel) {

                let rowId = "row" + index++;
                $("<div class='row flight'></div>").attr("id", rowId).append(
                    $("<div class='one wide column'></div>").append(
                        $("<div class='field'></div>").append(
                            $("<label>&nbsp;</label>"),
                            $("<button class='ui icon button'><i class='window close icon'></i></button>").click(function() { closeRow(rowId); })
                        )
                    ),
                    $("<div class='three wide column'></div>").append(
                        $("<div class='field'></div>").append(
                            $("<label>Departure airport</label>"),
                            $("<input class='flightModel'></input>")
                                .attr("data-property-name", "departureAirport")
                                .attr("placeholder", "XXX")
                                .attr("type", "text")
                                .attr("value", flightModel == null ? "" : flightModel.departureAirport)
                                .change(recomputeModel)
                        )
                    ),
                    $("<div class='three wide column'></div>").append(
                        $("<div class='field'></div>").append(
                            $("<label>Arrival airport</label>"),
                            $("<input class='flightModel'></input>")
                                .attr("data-property-name", "arrivalAirport")
                                .attr("placeholder", "XXX")
                                .attr("type", "text")
                                .attr("value", flightModel == null ? "" : flightModel.arrivalAirport)
                                .change(recomputeModel)
                        )
                    ),
                    $("<div class='three wide column'></div>").append(
                        $("<div class='field'></div>").append(
                            $("<label>Date</label>"),
                            $("<input class='flightModel'></input>")
                                .attr("data-property-name", "date")
                                .attr("type", "date")
                                .change(recomputeModel)
                                .attr("value", flightModel == null ? "" : flightModel.date)
                        )
                    ),
                    $("<div class='six wide column'>&nbsp;</div>"),
                    $("<div class='one wide column'>&nbsp;</div>"),
                    $("<div class='three wide column'></div>").append(
                        $("<div class='field'></div>").append(
                            $("<label>Depature min time</label>"),
                            $("<input class='flightModel'></input>")
                                .attr("data-property-name", "departureMinTime")
                                .attr("type", "time")
                                .attr("value", flightModel == null ? "" : flightModel.departureMinTime)
                                .change(recomputeModel)
                        )
                    ),
                    $("<div class='three wide column'></div>").append(
                        $("<div class='field'></div>").append(
                            $("<label>Depature max time</label>"),
                            $("<input class='flightModel'></input>")
                                .attr("data-property-name", "departureMaxTime")
                                .attr("type", "time")
                                .attr("value", flightModel == null ? "" : flightModel.departureMaxTime)
                                .change(recomputeModel)
                        )
                    ),
                    $("<div class='three wide column'></div>").append(
                        $("<div class='field'></div>").append(
                            $("<label>Arrival min time</label>"),
                            $("<input class='flightModel'></input>")
                                .attr("data-property-name", "arrivalMinTime")
                                .attr("type", "time")
                                .attr("value", flightModel == null ? "" : flightModel.arrivalMinTime)
                                .change(recomputeModel)
                        )
                    ),
                    $("<div class='three wide column'></div>").append(
                        $("<div class='field'></div>").append(
                            $("<label>Arrival max time</label>"),
                            $("<input class='flightModel'></input>")
                                .attr("data-property-name", "arrivalMaxTime")
                                .attr("type", "time")
                                .attr("value", flightModel == null ? "" : flightModel.arrivalMaxTime)
                                .change(recomputeModel)
                        )
                    )
                ).insertBefore($(".row.addFlightSeparator"));

                recomputeModel();

            }

            function openWebsites() {
                for (flightsearchWebsiteProvider in flightsearcherWebsiteProviders) {
                    if (flightSearchModel.activePages.indexOf(flightsearchWebsiteProvider) > -1) {
                        flightsearcherWebsiteProviders[flightsearchWebsiteProvider].openWebsite(flightSearchModel);
                    }
                }
            }

            $("#addRowButton").click(addFlightRow);
            $("#openWebsitesButton").click(openWebsites);
            $("input").change(recomputeModel);
            $("select").change(recomputeModel);

            let storedFlightSearchModelString = localStorage.getItem("flightSearchModel");
            let storedFlightSearchModel = storedFlightSearchModelString == null || storedFlightSearchModelString.length <= 0 ? null : JSON.parse(storedFlightSearchModelString);

            $(".query").append(
                $("<div class='row addFlightSeparator'></div>").append(
                    $("<div class='four wide column'></div>").append(
                        $("<button class='ui labeled icon button'></button>")
                            .append($("<i class='plus square icon'></i>"))
                            .append($("<span>Add flight</span>"))
                            .click(addFlightRow)
                    )
                ),
                $("<div class='row'></div>").append(
                    $("<div class='two wide column'></div>").append(
                        $("<div class='field'></div>").append(
                            $("<label>Passengers</label>"),
                            $("<input class='flightSearchModel' type='number' />")
                                .attr("data-property-name", "numberOfPassengers")
                                .val(storedFlightSearchModel == null || storedFlightSearchModel.numberOfPassengers == null || storedFlightSearchModel.numberOfPassengers <= 0 ? 1 : storedFlightSearchModel.numberOfPassengers)
                                .change(recomputeModel)
                        )
                    ),
                    $("<div class='two wide column'></div>").append(
                        $("<div class='field'></div>").append(
                            $("<label>Max transfers</label>"),
                            $("<input class='flightSearchModel' type='number' />")
                                .attr("data-property-name", "maxTransfers")
                                .val(storedFlightSearchModel == null || storedFlightSearchModel.maxTransfers == null || storedFlightSearchModel.maxTransfers <= 0 ? "" : storedFlightSearchModel.maxTransfers)
                                .change(recomputeModel)
                        )
                    ),
                    $("<div class='three wide column'></div>").append(
                        $("<div class='field'></div>").append(
                            $("<label>Max transfer duration</label>"),
                            $("<input class='flightSearchModel' type='time' />")
                                .attr("data-property-name", "maxTransferDuration")
                                .val(storedFlightSearchModel == null ? null : storedFlightSearchModel.maxTransferDuration)
                                .change(recomputeModel)
                        )
                    ),
                    $("<div class='three wide column'></div>").append(
                        $("<div class='field'></div>").append(
                            $("<label>Max total duration</label>"),
                            $("<input class='flightSearchModel' type='time' />")
                                .attr("data-property-name", "maxLegDuration")
                                .val(storedFlightSearchModel == null ? null : storedFlightSearchModel.maxLegDuration)
                                .change(recomputeModel)
                        )
                    )
                )
            );

            let categoriesRow = $("<div class='row'></div>");
            let categories = new Array();
            for (flightsearchWebsiteProvider in flightsearcherWebsiteProviders) {
                if (categories.indexOf(flightsearcherWebsiteProviders[flightsearchWebsiteProvider].category) < 0) {
                    categories.push(flightsearcherWebsiteProviders[flightsearchWebsiteProvider].category);
                }
            }
            for (category in categories) {
                let categoryField = $("<div class='field'></div>").append($("<label></label>").text(categories[category]));
                for (flightsearchWebsiteProvider in flightsearcherWebsiteProviders) {
                    if (categories[category] == flightsearcherWebsiteProviders[flightsearchWebsiteProvider].category) {
                        categoryField.append(
                            $("<div></div>").append(
                                $("<div class='ui checkbox'></div>").append(
                                    $("<input type='checkbox' class='activePageModel' />")
                                        .attr("data-page-name", flightsearchWebsiteProvider)
                                        .prop("checked", storedFlightSearchModel == null || storedFlightSearchModel.activePages == null ? false : storedFlightSearchModel.activePages.indexOf(flightsearchWebsiteProvider) > -1)
                                        .change(recomputeModel)
                                    ,
                                    $("<label></label>").text(flightsearcherWebsiteProviders[flightsearchWebsiteProvider].title)
                                )
                            )
                        );
                    }
                }
                categoriesRow.append($("<div class='three wide column'></div>").append(categoryField));
            }
            $(".query").append(categoriesRow);

            if (storedFlightSearchModel == null) {
                addFlightRow(null);
            } else {
                if (storedFlightSearchModel.flights == null || storedFlightSearchModel.flights.length < 1) {
                    addFlightRow(null);
                } else {
                    for (let i=0; i < storedFlightSearchModel.flights.length; i++) {
                        addFlightRow(storedFlightSearchModel.flights[i]);
                    }
                }
            }

        </script>

    </body>
</html>
